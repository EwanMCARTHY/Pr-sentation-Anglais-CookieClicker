<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cookie Factory Sim</title>
    <style>
        :root { --bg: #222; --panel: #333; --accent: #e67e22; --text: #eee; --green: #2ecc71; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); 
            text-align: center; padding: 10px; margin: 0;
            touch-action: manipulation; /* Prevents double-tap zoom */
        }
        
        /* Layout */
        .container { max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; height: 95vh; }
        .header { border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 10px; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        
        /* Screens */
        #setup-screen, #result-screen { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        #game-screen { display: none; flex: 1; flex-direction: column; }

        /* HUD */
        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: var(--panel); padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .stat-label { font-size: 0.8rem; color: #aaa; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        
        /* The Chart */
        .chart-container { background: #000; border: 1px solid #444; border-radius: 8px; height: 150px; position: relative; margin-bottom: 15px; overflow: hidden; }
        svg { width: 100%; height: 100%; }
        .chart-line { fill: none; stroke: var(--accent); stroke-width: 2; vector-effect: non-scaling-stroke; }

        /* Buttons */
        .btn { 
            background: linear-gradient(145deg, #444, #333); 
            color: white; border: none; padding: 15px; 
            font-size: 1.1rem; border-radius: 8px; 
            cursor: pointer; margin: 5px 0; 
            box-shadow: 0 4px #111; transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 #111; }
        
        .btn-action { 
            background: var(--accent); color: #000; font-weight: bold; font-size: 1.3rem; 
            height: 80px; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-action:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; transform: translateY(4px); }

        .btn-upgrade { border: 2px solid var(--green); color: var(--green); background: transparent; display: none; }
        
        /* Stock Animation */
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); } 100% { box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); } }
        .ready { animation: pulse 2s infinite; }

    </style>
</head>
<body>

<div class="container">

    <div id="setup-screen">
        <div style="font-size: 4rem; margin-bottom: 20px;">üè≠üç™</div>
        <h1>Cookie Factory<br>Manager</h1>
        <p>Select your assigned division</p>
        <button class="btn" onclick="selectStrat('A')">DIVISION A<br><small>Manual Labor</small></button>
        <button class="btn" onclick="selectStrat('B')">DIVISION B<br><small>Automation R&D</small></button>
        <button class="btn" onclick="selectStrat('C')">DIVISION C<br><small>High Risk Trading</small></button>
    </div>

    <div id="game-screen">
        <div class="header">
            <h1><span id="team-name">...</span></h1>
            <div id="timer" style="color: #e74c3c;">05:00</div>
        </div>

        <div class="chart-container">
            <svg id="chart-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                <polyline id="chart-line" class="chart-line" points="0,100 100,100"/>
            </svg>
            <div style="position: absolute; top:5px; left:5px; font-size:0.7rem; color:#666;">Production Curve</div>
        </div>

        <div class="hud-grid">
            <div class="stat-box">
                <div class="stat-label">TOTAL COOKIES</div>
                <div class="stat-val" id="score">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">WORK PERMITS</div>
                <div class="stat-val" id="stock">0</div>
            </div>
        </div>

        <button id="main-btn" class="btn btn-action" onclick="performAction()">
            <span>üç™ PRODUCE</span>
        </button>
        <div id="cooldown-msg" style="font-size: 0.8rem; color: #888; margin-top: 5px;">Generating Work Permit...</div>

        <button id="upg-btn" class="btn btn-upgrade" onclick="buyUpgrade()">
            üè≠ BUY FACTORY (Cost: 50)
        </button>
        
        <div style="flex:1;"></div>
        <div id="log" style="font-size: 0.8rem; color: #666; height: 50px; overflow: hidden; text-align: left;">System initialized...</div>
    </div>

    <div id="result-screen" style="display:none;">
        <h1>SHIFT ENDED</h1>
        <p>Final Production:</p>
        <div style="font-size: 4rem; color: var(--accent); font-weight: bold;" id="final-score">0</div>
        <div style="font-size: 0.9rem; color: #888;">(Do not close this page)</div>
    </div>

</div>

<script>
    // --- CONFIG ---
    const GAME_DURATION = 300; // 5 minutes
    const STOCK_REGEN_TIME = 5000; // 5 seconds per stock
    const CHART_UPDATE_INTERVAL = 2000; // Update chart every 2s

    // --- STATE ---
    let state = {
        score: 0,
        stock: 0, // "Work Permits"
        strategy: '',
        timeLeft: GAME_DURATION,
        autoRate: 0,
        history: [], // For the chart
        startTime: 0
    };

    let timers = {};

    function selectStrat(s) {
        state.strategy = s;
        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        
        const teamNames = {
            'A': 'The Grinders (Manual)',
            'B': 'The Investors (Auto)',
            'C': 'The Gamblers (Risk)'
        };
        document.getElementById('team-name').innerText = teamNames[s];

        if (s === 'B') {
            document.getElementById('upg-btn').style.display = 'block';
        }
        
        // Initial Stock
        state.stock = 2; // Start with 2 clicks ready
        updateUI();
        
        startGame();
    }

    function startGame() {
        state.startTime = Date.now();
        
        // 1. Global Timer (Countdown)
        timers.global = setInterval(() => {
            state.timeLeft--;
            let mins = Math.floor(state.timeLeft / 60).toString().padStart(2, '0');
            let secs = (state.timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${mins}:${secs}`;
            if (state.timeLeft <= 0) endGame();
        }, 1000);

        // 2. Stock Regen (The Cooldown Mechanic)
        timers.regen = setInterval(() => {
            state.stock++;
            log("New Work Permit granted.");
            updateUI();
        }, STOCK_REGEN_TIME);

        // 3. Auto-Production (For Strat B)
        timers.auto = setInterval(() => {
            if (state.autoRate > 0) {
                state.score += state.autoRate;
                updateUI();
            }
        }, 1000);

        // 4. Chart Updater
        timers.chart = setInterval(() => {
            // Add data point
            let progress = (GAME_DURATION - state.timeLeft) / GAME_DURATION; // 0 to 1
            state.history.push({ p: progress, v: state.score });
            drawChart();
        }, CHART_UPDATE_INTERVAL);
    }

    function performAction() {
        // Must have stock to click
        if (state.stock <= 0) {
            log("No Work Permits! Wait...");
            return;
        }

        let amount = 0;
        let consumedStock = 1;

        if (state.strategy === 'A') {
            amount = 5; // Standard efficiency
        } else if (state.strategy === 'B') {
            amount = 5; // Need to save these to buy factories
        } else if (state.strategy === 'C') {
            // High Variance
            let r = Math.random();
            if (r < 0.3) { amount = -10; log("Production Error! (-10)"); }
            else if (r > 0.8) { amount = 25; log("Market Boom! (+25)"); }
            else amount = 5;
        }

        state.score += amount;
        if (state.score < 0) state.score = 0;
        state.stock -= consumedStock;

        updateUI();
    }

    function buyUpgrade() {
        // Only for Strat B
        let cost = 50;
        if (state.score >= cost) {
            state.score -= cost;
            state.autoRate += 2; // +2 cookies/sec
            log(`Factory built! Auto: +${state.autoRate}/s`);
            updateUI();
        } else {
            log(`Need ${cost} cookies!`);
        }
    }

    function updateUI() {
        document.getElementById('score').innerText = Math.floor(state.score);
        document.getElementById('stock').innerText = state.stock;

        const btn = document.getElementById('main-btn');
        if (state.stock > 0) {
            btn.disabled = false;
            btn.style.opacity = "1";
            document.getElementById('cooldown-msg').style.visibility = 'hidden';
            btn.classList.add('ready');
        } else {
            btn.disabled = true;
            btn.style.opacity = "0.5";
            document.getElementById('cooldown-msg').style.visibility = 'visible';
            btn.classList.remove('ready');
        }
    }

    function log(msg) {
        document.getElementById('log').innerText = `> ${msg}`;
    }

    function drawChart() {
        if (state.history.length < 2) return;

        const svg = document.getElementById('chart-svg');
        const line = document.getElementById('chart-line');
        
        // Find max score for scaling Y
        let maxVal = 100;
        state.history.forEach(h => { if(h.v > maxVal) maxVal = h.v; });
        
        // Build points string "x,y x,y"
        // X is 0-100 (percentage of time)
        // Y is 100-0 (inverted percentage of value)
        let points = state.history.map(h => {
            let x = h.p * 100;
            let y = 100 - ((h.v / maxVal) * 100); 
            return `${x},${y}`;
        }).join(" ");

        line.setAttribute('points', points);
    }

    function endGame() {
        // Stop all timers
        for (let t in timers) clearInterval(timers[t]);
        
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('final-score').innerText = Math.floor(state.score);
    }
</script>
</body>
</html>